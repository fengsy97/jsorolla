<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Protein Lollipop demo</title>

    <link rel="stylesheet" href="../../../../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../../../node_modules/@fortawesome/fontawesome-free/css/all.min.css">

    <script type="text/javascript" src="../../../../node_modules/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="../../../../node_modules/cookies-js/dist/cookies.js"></script>
</head>
<body>
    <div style="max-width:1400px;margin-left:auto;margin-right:auto;">
        <h1 style="font-weight:bold;margin-bottom:16px;">Protein Lollipop Demo</h1>
        <div class="form-inline">
            <div class="form-group">
                <input type="text" class="form-control" id="geneInput" placeholder="TP53">
            </div>
            <button id="geneSubmit" class="btn btn-primary">
                <strong>Go</strong>
            </button>
        </div>
        <hr>
        <h3 id="geneTitle" style="font-weight:bold;"></h3>
        <div id="root"></div>
    </div>

    <script type="module">
        import {CellBaseClient} from "../../clients/cellbase/cellbase-client.js";
        import {OpenCGAClient} from "../../clients/opencga/opencga-client.js";
        import ProteinLollipop from "../protein-lollipop.js";

        const target = document.getElementById("root");
        const study = "demo@family:platinum";
        const studyTitle = "Platinum";
        let opencgaClient = null;
        let isRunning = false;

        const params = new URLSearchParams(window.location.search);
        const cellBaseClient = new CellBaseClient({
            host: params.get("CELLBASE_HOST") || "https://ws.zettagenomics.com/cellbase",
            version: params.get("CELLBASE_VERSION") || "v5.1",
            cache: {
                active: false,
            },
        });

        const initOpencgaClient = () => {
            if (opencgaClient) {
                return Promise.resolve();
            }
            opencgaClient = new OpenCGAClient({
                host: params.get("OPENCGA_HOST") || "https://ws.opencb.org/opencga-test",
                // host: params.get("OPENCGA_HOST") || "https://ws.opencb.org/opencga-prod",
                version: params.get("OPENCGA_VERSION") || "v2",
                // serverVersion: "1.4"
            });

            // Login into OpenCGA
            const user = "demouser";
            const password = "demouser";
            return opencgaClient.login(user, password)
                .then(() => {
                    console.log(`User '${user}' successfully logged in in opencga.`);
                })
                .catch(error => {
                    console.log(`Error logging in '${user}'`, e);
                });
        };

        // Draw protein lollipop
        const drawProteinLollipop = geneName => {
            isRunning = true;
            document.getElementById("geneTitle").textContent = geneName;

            while (target.firstChild) {
                target.removeChild(target.firstChild);
            }

            const promisesList = [
                // cellBaseClient.getProteinClient(null, "search", {gene: gene}),
                ProteinLollipop.getProteinInfoFromGene(cellBaseClient, geneName),
                initOpencgaClient().then(() => {
                    return opencgaClient.clinical().queryVariant({
                        study: study,
                        xref: geneName,
                        ct: ProteinLollipop.CONSEQUENCE_TYPES.join(","),
                    });
                }),
                // Clinvar variants
                cellBaseClient.get("clinical", "variant", null, "search", {
                    feature: geneName,
                    source: "clinvar",
                    consequenceType: ProteinLollipop.CONSEQUENCE_TYPES.join(","),
                    limit: 5000,
                }),
                // Cosmic variants 
                cellBaseClient.get("clinical", "variant", null, "search", {
                    feature: geneName,
                    source: "cosmic",
                    consequenceType: ProteinLollipop.CONSEQUENCE_TYPES.join(","),
                    limit: 5000,
                }),
            ];

            Promise.all(promisesList)
                .then(values => {
                    const protein = values[0]; // values[0].responses[0].results[0];
                    const variants = values[1].responses[0].results;

                    ProteinLollipop.draw(target, protein, variants, {
                        title: studyTitle,
                        tracks: [
                            {
                                title: "Clinvar",
                                variants: values[2]?.responses?.[0]?.results || [],
                            },
                            {
                                title: "Cosmic",
                                variants: values[3]?.responses?.[0]?.results || [],
                            },
                        ],
                    });
                })
                .catch(error => {
                    console.error(error);
                })
                .finally(() => {
                    isRunning = false;
                });
        };

        // Register gene submit event
        document.getElementById("geneSubmit").addEventListener("click", () => {
            const geneName = document.getElementById("geneInput").value;
            
            if (geneName && !isRunning) {
                drawProteinLollipop(geneName);
            }
        });

        // Initial gene
        drawProteinLollipop("MTM1");

    </script>
</body>
</html>
